<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contractor Job Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom style for address formatting to ensure line breaks are applied */
        .address-display {
            white-space: pre-wrap; /* Preserves whitespace and allows line breaks */
        }
        /* Style for the no jobs message */
        #no-jobs-message {
            font-size: 1.25rem; /* text-xl */
            color: #6b7280; /* gray-500 */
            margin-top: 2rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Main App Container -->
    <!-- Full-screen on mobile, centered card on desktop -->
    <div id="app" class="bg-white w-full max-w-3xl mx-auto md:my-8 md:rounded-2xl md:shadow-xl min-h-screen md:min-h-0">
        
        <!-- Login Section -->
        <div id="login-section" class="p-6 md:p-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Contractor Login</h2>
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username (Email):</label>
                <input type="email" id="username" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="password" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
            <button id="login-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300 ease-in-out text-lg">Login</button>
            <p id="login-message" class="text-red-500 text-xs italic mt-4 text-center"></p>
            <!-- Removed "Create New Account" button -->
        </div>

        <!-- Create Account Section (REMOVED) -->
        
        <!-- Jobs Section -->
        <div id="jobs-section" class="hidden p-4 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-gray-800">Available Jobs</h2>
                <button id="logout-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out text-sm">Logout</button>
            </div>
            
            <!-- Yellow Caution Banner (REMOVED) -->
            
            <p id="no-jobs-message" class="text-gray-600 text-center hidden">No jobs available at the moment.</p>
            <!-- Jobs list now has more spacing -->
            <div id="jobs-list" class="space-y-6">
                <!-- Job Cards will be injected here by renderJobs() -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://michie-detailing-backend.onrender.com';
        const API_URL_SMS = 'https://client-notifications.onrender.com/send-sms';
        const APP_FRONTEND_URL = 'https://jobs.michieauto.com';

        const loginSection = document.getElementById('login-section');
        // Removed createAccountSection
        const jobsSection = document.getElementById('jobs-section');

        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        // Removed showCreateAccountButton

        // Removed create account-related constants
        
        const logoutButton = document.getElementById('logout-button');
        const jobsList = document.getElementById('jobs-list');
        const noJobsMessage = document.getElementById('no-jobs-message');

        let authToken = localStorage.getItem('authToken');
        let currentMessageBox = null;

        // Custom Message Box (Replaces alert())
        function showCustomMessage(message, type = 'info') {
            if (currentMessageBox && document.body.contains(currentMessageBox)) {
                document.body.removeChild(currentMessageBox);
                currentMessageBox = null;
            }
            const messageBox = document.createElement('div');
            // Added z-50 to ensure it's on top
            messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            let bgColor = type === 'success' ? 'bg-green-100' : type === 'error' ? 'bg-red-100' : 'bg-blue-100';
            let textColor = type === 'success' ? 'text-green-800' : type === 'error' ? 'text-red-800' : 'text-blue-800';
            let btnStyle = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4';

            messageBox.innerHTML = `
                <div class="${bgColor} p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold ${textColor} mb-4">${message}</p>
                    <button id="message-box-ok" class="${btnStyle}">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            currentMessageBox = messageBox;
            document.getElementById('message-box-ok').addEventListener('click', () => {
                if (currentMessageBox && document.body.contains(currentMessageBox)) {
                    document.body.removeChild(currentMessageBox);
                    currentMessageBox = null;
                }
            });
        }

        // SMS Sending Function (Unchanged)
        async function sendAutoSMS(phoneNumber, messageContent, buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = 'Sending...';
            buttonElement.classList.add('opacity-50', 'cursor-not-allowed');

            const digitsOnly = phoneNumber.replace(/\D/g, '');
            const formattedPhoneNumber = digitsOnly.length === 10 ? `+1${digitsOnly}` : `+${digitsOnly}`;

            if (!formattedPhoneNumber || !/^\+\d{11,15}$/.test(formattedPhoneNumber)) {
                showCustomMessage('Error: Invalid phone number format for SMS.', 'error');
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                return;
            }
            if (!messageContent) {
                showCustomMessage("Error: No message content to send SMS.", 'error');
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                return;
            }

            try {
                const response = await fetch(API_URL_SMS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: formattedPhoneNumber, message_body: messageContent }),
                });
                const result = await response.json();
                if (response.ok) {
                    showCustomMessage(result.message || 'SMS sent successfully!', 'success');
                    buttonElement.textContent = 'Sent!';
                } else {
                    showCustomMessage(result.error || 'Failed to send SMS.', 'error');
                    buttonElement.disabled = false;
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('SMS Sending Error:', error);
                showCustomMessage(`An error occurred while sending SMS: ${error.message}`, 'error');
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // UI Update Logic (Simplified)
        function updateUI() {
            if (authToken) {
                loginSection.classList.add('hidden');
                // createAccountSection removed
                jobsSection.classList.remove('hidden');
                fetchJobs();
            } else {
                loginSection.classList.remove('hidden');
                // createAccountSection removed
                jobsSection.classList.add('hidden');
                jobsList.innerHTML = '';
                noJobsMessage.classList.add('hidden');
            }
        }

        // Login Logic (Unchanged)
        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('contractorEmail', username); 
                    loginMessage.textContent = '';
                    updateUI();
                } else {
                    loginMessage.textContent = data.message || 'Login failed. Please check your credentials.';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginMessage.textContent = 'An error occurred during login.';
            }
        });

        // Logout Logic (Unchanged)
        logoutButton.addEventListener('click', () => {
            authToken = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('contractorEmail');
            updateUI();
        });

        // Removed all create account event listeners

        // --- Formatting Functions (Unchanged) ---
        function formatAppointmentDate(dateString) {
            if (!dateString || dateString === "N/A") return "N/A";
            try {
                const [year, month, day] = dateString.split('-');
                return `${month}-${day}-${year}`;
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return dateString;
            }
        }

        function formatAppointmentTime(timeString) {
            if (!timeString || timeString === "N/A") return "N/A";
            try {
                const [hours, minutes] = timeString.split(':');
                let hour = parseInt(hours, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hour = hour % 12;
                hour = hour ? hour : 12;
                return `${hour}:${minutes} ${ampm}`;
            } catch (e) {
                console.error("Error formatting time:", timeString, e);
                return timeString;
            }
        }

        function formatCustomerAddress(addressString) {
            if (!addressString || addressString === "N/A") return "N/A";
            return addressString.replace(/, /g, ',<br>');
        }
        
        function formatPhoneNumber(phoneString) {
            if (!phoneString || phoneString === "N/A") return "N/A";
            const cleaned = ('' + phoneString).replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return '(' + match[1] + ') ' + match[2] + '-' + match[3];
            }
            return phoneString;
        }

        // --- NEW Helper Function for iCalendar Links ---
        /**
         * Formats date, time, and duration for an iCalendar (.ics) file.
         * Returns start and end times in 'YYYYMMDDTHHMMSS' format (floating local time).
         */
        function formatICalDateTime(date, time, durationStr) {
            // Helper to format a Date object into iCal string
            const toICalString = (dateObj) => {
                const pad = (num) => num.toString().padStart(2, '0');
                return `${dateObj.getFullYear()}${pad(dateObj.getMonth() + 1)}${pad(dateObj.getDate())}T${pad(dateObj.getHours())}${pad(dateObj.getMinutes())}00`;
            };

            // Default to 2 hours if duration is invalid
            let durationHours = 2; 
            if (durationStr && durationStr !== "N/A") {
                const parsedDuration = parseFloat(durationStr);
                if (!isNaN(parsedDuration)) {
                    durationHours = parsedDuration;
                }
            }

            // Guard against invalid date/time
            if (!date || date === "N/A" || !time || time === "N/A") {
                console.warn("Cannot generate iCal time, missing date or time.");
                // Return a default or handle error appropriately
                const now = new Date();
                const later = new Date(now.getTime() + durationHours * 60 * 60 * 1000);
                return { start: toICalString(now), end: toICalString(later) };
            }

            try {
                const [year, month, day] = date.split('-').map(Number);
                const [hour, minute] = time.split(':').map(Number);
                
                // Create date in local time
                const startDate = new Date(year, month - 1, day, hour, minute); 
                const endDate = new Date(startDate.getTime() + durationHours * 60 * 60 * 1000);

                return {
                    start: toICalString(startDate),
                    end: toICalString(endDate)
                };
            } catch (e) {
                console.error("Error formatting iCal date:", e);
                // Fallback
                const now = new Date();
                const later = new Date(now.getTime() + durationHours * 60 * 60 * 1000);
                return { start: toICalString(now), end: toICalString(later) };
            }
        }


        // Fetch Jobs (Unchanged)
        async function fetchJobs() {
            if (!authToken) {
                console.log('Not authenticated. Cannot fetch jobs.');
                return;
            }

            // --- ADDED LOADING STATE ---
            // Clear list, then show a loading message immediately.
            jobsList.innerHTML = ''; 
            noJobsMessage.textContent = 'Loading available jobs...';
            noJobsMessage.classList.remove('hidden');
            // --- END LOADING STATE ---

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();
                if (response.ok) {
                    // renderJobs will automatically hide the "Loading..." message
                    // if jobs are found, or update it if no jobs are available.
                    renderJobs(data);
                } else {
                    jobsList.innerHTML = '';
                    noJobsMessage.textContent = data.message || 'Error fetching jobs.';
                    noJobsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Fetch jobs error:', error);
                jobsList.innerHTML = '';
                noJobsMessage.textContent = 'An error occurred while fetching jobs.';
                noJobsMessage.classList.remove('hidden');
            }
        }

        // --- (MODIFIED) renderJobs Function ---
        // This function contains the new "Dasher" layout
        function renderJobs(jobs) {
            jobsList.innerHTML = '';
            let renderedJobCount = 0;
            const contractorEmail = localStorage.getItem('contractorEmail');

            jobs.forEach(job => {
                let showJob = false;
                if (job.status === 'pending') {
                    showJob = true;
                } else if (job.status === 'accepted') {
                    if (job.contractor_id_field === contractorEmail) {
                        showJob = true;
                    }
                }
                
                if (showJob) {
                    const jobCard = document.createElement('div');
                    // New Card Style: White bg, rounded, shadow, flexible column layout
                    jobCard.className = 'bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col';

                    let jobDescriptionHTML = '';

                    // --- Pay Display Logic ---
                    let payDisplay = "N/A";
                    // New: Default is a lighter gray for N/A, prominent green for actual pay
                    let payClass = "bg-gray-100 text-gray-700"; 
                    if (job.pay && job.pay !== "N/A") {
                        payDisplay = job.pay;
                        if (job.pay.toLowerCase() === "hourly + tips") {
                            payDisplay = "$120 + Tips";
                        }
                        // This is the key change: make it green and big
                        payClass = "bg-green-600 text-white";
                    }

                    // --- Main Title (Vehicle) ---
                    let mainTitle = '';
                    if (job.year && job.year !== "N/A") mainTitle += job.year + ' ';
                    if (job.make && job.make !== "N/A") mainTitle += job.make + ' ';
                    if (job.model && job.model !== "N/A") mainTitle += job.model;
                    if (mainTitle.trim() === "") mainTitle = "Untitled Job";
                    mainTitle = mainTitle.trim();

                    // --- (MODIFIED) Appointment Info (with icon) ---
                    let appointmentInfo = '';
                    if (job.appointment_date && job.appointment_date !== "N/A") {
                        // ADDED text-base
                        appointmentInfo += `<div class="flex items-center text-base"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> <span>${formatAppointmentDate(job.appointment_date)}`;
                        if (job.appointment_time && job.appointment_time !== "N/A") {
                            appointmentInfo += ` at ${formatAppointmentTime(job.appointment_time)}`;
                        }
                        appointmentInfo += '</span></div>';
                    } else if (job.appointment_time && job.appointment_time !== "N/A") {
                        // ADDED text-base
                        appointmentInfo += `<div class="flex items-center text-base"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>${formatAppointmentTime(job.appointment_time)}</span></div>`;
                    }

                    // --- (MODIFIED) Location (Zip, with icon) ---
                    let zipInfo = '';
                    if (job.zip_code && job.zip_code !== "N/A") {
                        // ADDED text-base, REMOVED mt-2
                        zipInfo = `<div class="flex items-center text-base"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> <span>${job.zip_code}</span></div>`;
                    }

                    // --- Estimated Time (with icon) ---
                    let estTimeInfo = '';
                    let estTimeInfoShort = ''; // For the header
                    if (job.estimated_time && job.estimated_time !== "N/A") {
                        estTimeInfo = `<div class="flex items-center mt-2"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>${job.estimated_time}</span></div>`;
                        estTimeInfoShort = `<div class="flex items-center text-sm text-gray-600"><svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>${job.estimated_time}</span></div>`;
                    }

                    // --- (MODIFIED) Service Level ---
                    let serviceInfo = '';
                    if (job.service_level && job.service_level !== "N/A" && job.service_level.trim() !== "") {
                        // NEW: Make it larger, semi-bold, and give it an icon
                        serviceInfo = `<div class="flex items-center text-base text-gray-800 font-medium"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg> <span>${job.service_level}</span></div>`;
                    }

                    // --- PENDING JOB CARD ---
                if (job.status === 'pending') {
                    // ... (mainTitle, serviceInfo, appointmentInfo, zipInfo, estTimeInfo) ...

                    // --- Pay button ---
                    let payDisplay = '$0.00';
                    if (job.pay && job.pay !== "N/A") {
                        payDisplay = (job.pay.toLowerCase() === "hourly + tips") ? "$120 + Tips" : `$${parseFloat(job.pay).toFixed(2)} + TIPS`;
                    }
                    
                    // (MODIFIED) Pay button is now full width, no flex-1
                    const payButton = `
                        <div class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-center text-lg">
                            ${payDisplay}
                        </div>`;

                    // --- Action buttons ---
                    // (MODIFIED) Kept flex-1 so they split the row they share
                    const declineButton = `<button data-job-id="${job.id}" class="decline-button flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">Decline</button>`;
                    const acceptButton = `<button data-job-id="${job.id}" class="accept-button flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">Accept Job</button>`;

                    jobCard.innerHTML = `
                        <div class="p-5">
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">${mainTitle.trim()}</h3>
                            <div class="space-y-2 mb-4">
                                ${appointmentInfo}
                                ${zipInfo}
                                ${serviceInfo}
                            </div>
                            ${estTimeInfo}
                        </div>
                        <!-- (MODIFIED) This is the new, cleaner layout -->
                        <div class="bg-gray-50 px-5 py-4 border-t border-gray-100 space-y-3">
                            ${payButton}
                            <div class="flex space-x-3">
                                ${declineButton}
                                ${acceptButton}
                            </div>
                        </div>
                    `;
                    jobsList.appendChild(jobCard);
                    renderedJobCount++;
                } 
                // --- ACCEPTED JOB CARD ---
                else if (job.status === 'accepted') {
                        // --- Customer Details (with icons) ---
                        let customerDetails = '';
                        if (job.customer_name && job.customer_name !== "N/A") {
                            customerDetails += `<div class="flex items-center"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> <span>${job.customer_name}</span></div>`;
                        }
                        if (job.customer_phone && job.customer_phone !== "N/A") {
                            const telLink = job.customer_phone.replace(/\D/g, '');
                            const formattedPhone = formatPhoneNumber(job.customer_phone);
                            customerDetails += `<div class="flex items-center mt-2"><svg class="w-4 h-4 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg> <a href="tel:${telLink}" class="text-blue-500 hover:underline">${formattedPhone}</a></div>`;
                        }
                        if (job.customer_address && job.customer_address !== "N/A") {
                            const encodedAddress = encodeURIComponent(job.customer_address);
                            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                            customerDetails += `<div class="flex items-start mt-2"><svg class="w-4 h-4 mr-2 mt-1 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline"><span class="address-display">${formatCustomerAddress(job.customer_address)}</span></a></div>`;
                        }

                        // --- (MODIFIED) "When & Where" section for larger text ---
                        let largeAppointmentInfo = '';
                        if (job.appointment_date && job.appointment_date !== "N/A") {
                            largeAppointmentInfo = `<div class="flex items-center text-base text-gray-800 font-medium"><svg class="w-5 h-5 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> <span>${formatAppointmentDate(job.appointment_date)}`;
                            if (job.appointment_time && job.appointment_time !== "N/A") {
                                largeAppointmentInfo += ` at ${formatAppointmentTime(job.appointment_time)}`;
                            }
                            largeAppointmentInfo += '</span></div>';
                        } else if (job.appointment_time && job.appointment_time !== "N/A") {
                            largeAppointmentInfo = `<div class="flex items-center text-base text-gray-800 font-medium"><svg class="w-5 h-5 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>${formatAppointmentTime(job.appointment_time)}</span></div>`;
                        }

                        let largeZipInfo = '';
                        if (job.zip_code && job.zip_code !== "N/A") {
                            largeZipInfo = `<div class="flex items-center mt-2 text-base text-gray-800 font-medium"><svg class="w-5 h-5 mr-2 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> <span>${job.zip_code}</span></div>`;
                        }

                        // --- NEW: Generate iCalendar (.ics) link ---
                        const iCalTimes = formatICalDateTime(job.appointment_date, job.appointment_time, job.estimated_time);
                        const eventTitle = `${mainTitle} Car Detail for ${job.customer_name || 'Client'}`;
                        
                        // --- MODIFIED FOR SECURITY ---
                        // Set empty location for security
                        const eventLocation = ''; 
                        // Removed Phone and Address from description
                        const eventDescription = `Job Details:\\nVehicle: ${mainTitle}\\nCustomer: ${job.customer_name || 'N/A'}`; 

                        const icsData = [
                            'BEGIN:VCALENDAR',
                            'VERSION:2.0',
                            'BEGIN:VEVENT',
                            `DTSTART:${iCalTimes.start}`,
                            `DTEND:${iCalTimes.end}`,
                            `SUMMARY:${eventTitle}`,
                            `LOCATION:${eventLocation}`, // Will be empty
                            `DESCRIPTION:${eventDescription.replace(/\n/g, '\\n')}`, // Escape newlines
                            'END:VEVENT',
                            'END:VCALENDAR'
                        ].join('\n');
                        
                        // Use download attribute to suggest a filename
                        const icsUri = `data:text/calendar;charset=utf8,${encodeURIComponent(icsData)}`;
                        const icsButton = `<a href="${icsUri}" download="${eventTitle}.ics" class="inline-block w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out text-sm text-center mt-4">Add to Calendar</a>`;


                        // --- Bonus Box (with full-width buttons) ---
                        let bonusBoxHTML = `
                            <div class="bg-green-50 text-green-800 p-4 rounded-lg border border-green-200 my-4">
                                <p class="font-bold mb-3">Bonus Opportunities</p>
                                <div class="mb-4">
                                    <p class="mb-2"><strong>Protection Plan:</strong> $20 Commission per plan sold</p>`;
                        if (job.customer_phone && job.customer_phone !== "N/A") {
                            // --- MODIFIED BUTTON COLOR ---
                            bonusBoxHTML += `<button data-phone="${job.customer_phone}" data-sms-type="protection" class="send-sms-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out text-sm text-center">Send Protection Plan Message</button>`;
                        }
                        bonusBoxHTML += `</div><div>
                                    <p class="mb-2"><strong>Google Review:</strong> $12 Bonus for a photo review</p>`;
                        if (job.customer_phone && job.customer_phone !== "N/A") {
                            // --- MODIFIED BUTTON COLOR ---
                            bonusBoxHTML += `<button data-phone="${job.customer_phone}" data-sms-type="review" class="send-sms-button w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out text-sm text-center">Send Review Request</button>`;
                        }
                        bonusBoxHTML += `</div></div>`; // Close the green box divs

                        // --- Build Accepted Card HTML ---
                        jobDescriptionHTML = `
                            <!-- Top Header: Accepted -->
                            <div class="p-4 bg-green-50 border-b border-green-200">
                                <h3 class="text-lg font-bold text-green-800">Job Accepted!</h3>
                                <!-- Removed mainTitle from here -->
                            </div>

                            <!-- Main Content Area -->
                            <div class="p-5 flex-grow">
                                
                                <!-- NEW Vehicle Section -->
                                <div>
                                    <h4 class="text-xs uppercase text-gray-500 font-semibold mb-1">Vehicle</h4>
                                    <p class="text-2xl font-bold text-gray-800">${mainTitle}</p>
                                </div>
                                <!-- (MODIFIED) When & Where Section (added border) -->
                                <div class="mt-4 border-t pt-4 border-gray-200">
                                    <h4 class="text-xs uppercase text-gray-500 font-semibold mb-2">When & Where</h4>
                                    <div class="text-gray-700 space-y-2">
                                        ${largeAppointmentInfo}
                                        ${largeZipInfo}
                                        ${serviceInfo} <!-- MOVED HERE -->
                                        ${estTimeInfo} <!-- This one remains the original smaller size -->
                                    </div>
                                    ${icsButton} <!-- NEW CALENDAR BUTTON -->
                                    <!-- ${serviceInfo} REMOVED FROM HERE -->
                                </div>
                                
                                <div class="mt-4 border-t pt-4 border-gray-200">
                                    <h4 class="text-xs uppercase text-gray-500 font-semibold mb-3">Customer Details</h4>
                                    <div class="text-sm text-gray-700 space-y-2">
                                        ${customerDetails}
                                    </div>
                                </div>

                                <div class="mt-4 border-t pt-4 border-gray-200">
                                    <h4 class="text-xs uppercase text-gray-500 font-semibold mb-3">Pay</h4>
                                    <!-- PAY BUTTON (Styled as info) -->
                                    <div class="${payClass} text-lg font-bold py-3 px-5 rounded-lg text-center">
                                        ${payDisplay}
                                    </div>
                                </div>

                                <!-- BONUS BOX -->
                                ${bonusBoxHTML}
                            </div>
                        `;

                        // --- (MOVED INSIDE) This logic now only applies to ACCEPTED jobs ---
                        jobCard.innerHTML = jobDescriptionHTML;
                        jobsList.appendChild(jobCard);
                        renderedJobCount++;
                        // --- End of moved logic ---
                    }

                    // --- (REMOVED) These lines were causing the bug ---
                    // jobCard.innerHTML = jobDescriptionHTML; 
                    // jobsList.appendChild(jobCard);
                    // renderedJobCount++;
                    // --- End of removed lines ---
                }
            });

            if (renderedJobCount === 0) {
                noJobsMessage.textContent = "No jobs available at the moment.";
                noJobsMessage.classList.remove('hidden');
            } else {
                noJobsMessage.classList.add('hidden');
            }

            // --- Add Event Listeners ---
            document.querySelectorAll('.accept-button').forEach(button => {
                button.addEventListener('click', (event) => handleJobAction(event.target.dataset.jobId, 'accept', event.target));
            });
            document.querySelectorAll('.decline-button').forEach(button => {
                button.addEventListener('click', (event) => handleJobAction(event.target.dataset.jobId, 'decline', event.target));
            });
            
            document.querySelectorAll('.send-sms-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const btn = event.currentTarget;
                    const phone = btn.dataset.phone;
                    const smsType = btn.dataset.smsType;
                    
                    const messages = {
                        protection: "Protect your vehicle with our protection plan which covers you for 60 days with one $0 out of pocket cost detail. Signup now at https://michieauto.com/protection",
                        review: "Michie Auto Detailing LLC would love your feedback. Post a photo review to our profile, it only takes 3 minutes! https://g.page/r/CcRJGcUyQxksEBE/review"
                    };

                    const message = messages[smsType];
                    
                    if (phone && message) {
                        sendAutoSMS(phone, message, btn);
                    } else {
                        showCustomMessage('Error: Missing phone number or message type.', 'error');
                    }
                });
            });
        }

        // --- (MODIFIED) handleJobAction Function ---
        // Replaced alert() with showCustomMessage()
        async function handleJobAction(jobId, actionType, buttonElement) {
            if (!authToken) {
                console.log('Not authenticated. Cannot proceed with job action.');
                showCustomMessage('You must be logged in to perform this action.', 'error');
                return;
            }

            // Find both buttons in the card to disable them and prevent double-clicks
            const card = buttonElement.closest('.bg-gray-50'); // Find the action bar
            if (!card) {
                console.error('Could not find parent card for action buttons.');
                return;
            }
            const acceptButton = card.querySelector('.accept-button');
            const declineButton = card.querySelector('.decline-button');
            
            if (!acceptButton || !declineButton) {
                console.error('Could not find accept/decline buttons.');
                return;
            }

            const originalAcceptText = acceptButton.textContent;
            const originalDeclineText = declineButton.textContent;

            // Disable both buttons and add visual cues
            acceptButton.disabled = true;
            declineButton.disabled = true;
            acceptButton.classList.add('opacity-50', 'cursor-not-allowed');
            declineButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Change text to show processing
            if (actionType === 'accept') {
                acceptButton.textContent = 'Accepting...';
            } else {
                declineButton.textContent = 'Declining...';
            }

            try {
                const response = await fetch(`${API_BASE_URL}/jobs/${jobId}/${actionType}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();
                if (response.ok) {
                    console.log(`Job ${jobId} ${actionType}ed successfully. Status: ${data.message}`);
                    // Refresh the job list. The buttons will be removed from the DOM.
                    fetchJobs();
                } else {
                    // Replaced alert()
                    showCustomMessage(data.message || `Failed to ${actionType} job.`, 'error');
                    console.error(`Failed to ${actionType} job:`, data.message);
                    // If the action fails, re-enable the buttons so the user can try again.
                    acceptButton.disabled = false;
                    declineButton.disabled = false;
                    acceptButton.textContent = originalAcceptText;
                    declineButton.textContent = originalDeclineText;
                    acceptButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    declineButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error(`Error during ${actionType} job:`, error);
                // Replaced alert()
                showCustomMessage(`An error occurred while trying to ${actionType} the job.`, 'error');
                // Also re-enable on network error.
                acceptButton.disabled = false;
                declineButton.disabled = false;
                acceptButton.textContent = originalAcceptText;
                declineButton.textContent = originalDeclineText;
                acceptButton.classList.remove('opacity-50', 'cursor-not-allowed');
                declineButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Initial Load
        document.addEventListener('DOMContentLoaded', updateUI);
    </script>
</body>
</html>







