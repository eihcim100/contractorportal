<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michie Auto Detailing Contractor Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 30px; width: 100%; max-width: 600px; }
        h1 { color: #1f2937; font-size: 2rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
        #login-signup-container, #job-portal-container { padding: 20px; border-radius: 8px; background-color: #f9fafb; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        #job-portal-container { display: none; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }
        button { background-color: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s; width: 100%; margin-top: 10px;}
        button:hover { background-color: #2563eb; }
        .job-card { background-color: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .job-card h3 { font-size: 1.2rem; font-weight: 700; color: #1f2937; margin-bottom: 10px; }
        .job-card p { font-size: 0.9rem; color: #4b5563; line-height: 1.5; margin-bottom: 8px; }
        .job-card .actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .job-card .actions button { width: auto; padding: 8px 15px; font-size: 0.9rem; margin-top: 0; }
        .job-card .actions .claim-btn { background-color: #10b981; }
        .job-card .actions .claim-btn:hover { background-color: #059669; }
        .notification { position: fixed; top: 20px; right: 20px; background-color: #d1fae5; color: #065f46; padding: 12px 20px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; display: none; }
        .notification.error { background-color: #fee2e2; color: #991b1b; }
        .tab-button-container { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-button { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-bottom: none; background-color: #e5e7eb; cursor: pointer; font-weight: 600; }
        .tab-button.active { background-color: #f9fafb; border-bottom: 1px solid #f9fafb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Michie Auto Detailing Portal</h1>

        <div id="notification-area" class="notification"></div>

        <div id="login-signup-container">
            <div class="tab-button-container">
                <button class="tab-button active" data-tab="login">Login</button>
                <button class="tab-button" data-tab="signup">Sign Up</button>
            </div>

            <div id="login-tab" class="tab-content active">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Contractor Login</h2>
                <div class="input-group">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" placeholder="Enter your username">
                </div>
                <div class="input-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button id="login-btn">Login</button>
            </div>

            <div id="signup-tab" class="tab-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">New Contractor Sign Up</h2>
                <div class="input-group">
                    <label for="signup-name">Full Name:</label>
                    <input type="text" id="signup-name" placeholder="Your Full Name">
                </div>
                <div class="input-group">
                    <label for="signup-email">Email:</label>
                    <input type="email" id="signup-email" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label for="signup-username">Username:</label>
                    <input type="text" id="signup-username" placeholder="Choose a username">
                </div>
                <div class="input-group">
                    <label for="signup-password">Password:</label>
                    <input type="password" id="signup-password" placeholder="Choose a password">
                </div>
                <button id="signup-btn">Sign Up</button>
            </div>
        </div>

        <div id="job-portal-container">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Available Jobs</h2>
            <div id="job-list">
                </div>
            <p id="no-jobs-message" class="text-center text-gray-500 text-lg mt-8" style="display: none;">No jobs available at the moment.</p>
        </div>
    </div>

    <script>
        console.log("Script loaded and starting!"); // DEBUG: Confirm script starts

        // --- Configuration ---
        const SERVER_URL = 'https://michie-detailing-backend.onrender.com'; 
        let currentUser = null; // Store logged-in user info

        // --- DOM Elements ---
        const notificationArea = document.getElementById('notification-area');
        const loginSignupContainer = document.getElementById('login-signup-container');
        const jobPortalContainer = document.getElementById('job-portal-container');
        const jobListDiv = document.getElementById('job-list');
        const noJobsMessage = document.getElementById('no-jobs-message');

        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');

        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupUsernameInput = document.getElementById('signup-username');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupBtn = document.getElementById('signup-btn');

        // --- DEBUG: Verify DOM Elements Found ---
        console.log("DOM Elements found (should not be null):");
        console.log("notificationArea:", notificationArea);
        console.log("loginSignupContainer:", loginSignupContainer);
        console.log("jobPortalContainer:", jobPortalContainer);
        console.log("jobListDiv:", jobListDiv);
        console.log("noJobsMessage:", noJobsMessage);
        console.log("loginUsernameInput:", loginUsernameInput);
        console.log("loginPasswordInput:", loginPasswordInput);
        console.log("loginBtn:", loginBtn);
        console.log("signupNameInput:", signupNameInput);
        console.log("signupEmailInput:", signupEmailInput);
        console.log("signupUsernameInput:", signupUsernameInput);
        console.log("signupPasswordInput:", signupPasswordInput);
        console.log("signupBtn:", signupBtn);

        // --- Tab Switching Logic ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab + '-tab').classList.add('active');
            });
        });

        // --- Notification Function ---
        function showNotification(message, type = 'success') {
            if (notificationArea) { // Check if element exists before using
                notificationArea.textContent = message;
                notificationArea.classList.remove('success', 'error');
                notificationArea.classList.add(type);
                notificationArea.style.display = 'block';
                setTimeout(() => { notificationArea.style.display = 'none'; }, 3000);
            } else {
                console.error("Notification area not found!");
                alert(message); // Fallback alert
            }
        }

        // --- API Calls ---
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (data) options.body = JSON.stringify(data);

            try {
                // THIS IS THE CRUCIAL LINE: Using template literals correctly
                const response = await fetch(`${SERVER_URL}${endpoint}`, options); 
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `API error: ${response.status} ${response.statusText}`);
                }
                return result;
            } catch (error) {
                console.error(`API request to ${endpoint} failed:`, error);
                showNotification(`Error: ${error.message || 'Network issue'}`, 'error');
                throw error; // Re-throw to be caught by specific handlers
            }
        }

        // --- Render Jobs ---
        function renderJobs(jobs) {
            if (!jobListDiv) { console.error("Job list container not found!"); return; } // Check if element exists
            jobListDiv.innerHTML = '';
            if (jobs.length === 0) {
                if (noJobsMessage) noJobsMessage.style.display = 'block';
            } else {
                if (noJobsMessage) noJobsMessage.style.display = 'none';
                jobs.forEach(job => {
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job-card';
                    jobCard.dataset.jobId = job.id; // Airtable record ID

                    // Adjust these field names to EXACTLY match your Airtable "Appointments" table columns
                    const customerName = job.fields['Customer Name'] || 'N/A';
                    const serviceType = job.fields['Service Type'] || 'N/A';
                    const address = job.fields['Customer Address'] || 'N/A';
                    const phone = job.fields['Customer Phone'] || 'N/A';
                    const apptDate = job.fields['Appointment Date'] || 'N/A';
                    const apptTime = job.fields['Appointment Time'] || 'N/A';
                    const vehicle = job.fields['Vehicle Make/Model'] || 'N/A';
                    const notes = job.fields['Customer Notes'] || 'N/A';

                    // Adjust these AI field names to EXACTLY match your Airtable "Appointments" table columns
                    // If you don't have these fields in Airtable, they will show 'N/A' or default.
                    const aiNotesSummary = job.fields['AI_Notes_Summary'] || 'No AI summary available.';
                    const aiEstDuration = job.fields['AI_Est_Duration_Hours'] || 'N/A';
                    // Removed AI Upsell Suggestions as requested


                    jobCard.innerHTML = `
                        <h3>${serviceType} for ${customerName}</h3>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>Phone:</strong> ${phone}</p>
                        <p><strong>Date:</strong> ${apptDate} at ${apptTime}</p>
                        <p><strong>Vehicle:</strong> ${vehicle}</p>
                        <p><strong>Notes:</strong> ${notes}</p>
                        <p class="mt-2 text-sm text-gray-700"><strong>AI Summary:</strong> ${aiNotesSummary}</p>
                        <p class="text-sm text-gray-700"><strong>AI Est. Duration:</strong> ${aiEstDuration} hours</p>
                        <div class="actions">
                            <button class="claim-btn" data-job-id="${job.id}">Claim Job</button>
                        </div>
                    `;
                    jobListDiv.appendChild(jobCard);
                });
            }
        }

        // --- Event Listeners ---

        // Debugging check to ensure button elements exist before attaching listeners
        if (loginBtn) {
            loginBtn.addEventListener('click', async () => {
                console.log("Login button clicked!"); // DEBUG: Confirm click registered
                const username = loginUsernameInput.value;
                const password = loginPasswordInput.value;
                if (!username || !password) {
                    showNotification('Please enter username and password.', 'error');
                    return;
                }
                try {
                    const result = await apiRequest('/api/login', 'POST', { username, password });
                    if (result.success) {
                        currentUser = result.user; // Store user details (includes Airtable fields)
                        showNotification(`Welcome, ${currentUser.fields['Contractor Name']}!`);
                        if (loginSignupContainer) loginSignupContainer.style.display = 'none';
                        if (jobPortalContainer) jobPortalContainer.style.display = 'block';
                        fetchAndRenderJobs();
                    } else {
                        showNotification(result.message || 'Login failed.', 'error');
                    }
                } catch (error) {
                    showNotification(error.message || 'Login failed due to network issue.', 'error');
                }
            });
        } else {
            console.error("DEBUG ERROR: Login button element not found! Check its ID in HTML.");
        }


        if (signupBtn) {
            signupBtn.addEventListener('click', async () => {
                console.log("Sign Up button clicked!"); // DEBUG: Confirm click registered
                const name = signupNameInput.value;
                const email = signupEmailInput.value;
                const username = signupUsernameInput.value;
                const password = signupPasswordInput.value;
                if (!name || !email || !username || !password) {
                    showNotification('All signup fields are required.', 'error');
                    return;
                }
                try {
                    const result = await apiRequest('/api/signup', 'POST', { name, email, username, password });
                    if (result.success) {
                        showNotification(result.message);
                        // Switch to login tab after successful signup
                        const loginTabButton = document.querySelector('.tab-button[data-tab="login"]');
                        if (loginTabButton) loginTabButton.click();
                        // Clear signup form
                        signupNameInput.value = '';
                        signupEmailInput.value = '';
                        signupUsernameInput.value = '';
                        signupPasswordInput.value = '';
                    } else {
                        showNotification(result.message || 'Signup failed.', 'error');
                    }
                } catch (error) {
                    showNotification(error.message || 'Signup failed due to network issue.', 'error');
                    console.error("Signup error details:", error); // More detailed logging
                }
            });
        } else {
            console.error("DEBUG ERROR: Sign Up button element not found! Check its ID in HTML.");
        }


        // Delegated event listener for Claim Job buttons (inside jobListDiv)
        if (jobListDiv) {
            jobListDiv.addEventListener('click', async (event) => {
                if (event.target.classList.contains('claim-btn')) {
                    if (!currentUser || !currentUser.id) {
                        showNotification('Please log in to claim jobs.', 'error');
                        return;
                    }
                    const jobId = event.target.dataset.jobId; // Airtable record ID of the job
                    try {
                        const result = await apiRequest('/api/jobs/claim', 'POST', {
                            jobId: jobId,
                            contractorId: currentUser.id, // Airtable record ID of the contractor
                            contractorName: currentUser.fields['Contractor Name'] // Contractor's name from Airtable fields
                        });
                        if (result.success) {
                            showNotification(result.message);
                            fetchAndRenderJobs(); // Refresh job list

                            // --- About the Detailer Notification (Server-side Trigger) ---
                            // This part would ideally be triggered by your server after job claim.
                            // The client-side simply requests the info for demonstration.
                            try {
                                const bioResult = await apiRequest(`/api/contractors/${currentUser.id}/bio`);
                                if(bioResult.success) {
                                    console.log('--- FOR CUSTOMER NOTIFICATION ---');
                                    console.log(bioResult.bio); // This is the message your customer would receive!
                                    console.log('--- Send this message to customer via SMS/Email using Zapier/similar from your server ---');
                                }
                            } catch (bioError) {
                                console.error('Failed to get contractor bio for notification:', bioError);
                            }

                        } else {
                            showNotification(result.message || 'Failed to claim job.', 'error');
                        }
                    } catch (error) {
                        showNotification(error.message || 'Failed to claim job due to network issue.', 'error');
                    }
                }
            });
        } else {
            console.error("DEBUG ERROR: Job list container not found! Check its ID in HTML.");
        }


        // --- Initial Load ---
        async function fetchAndRenderJobs() {
            // Ensure the jobPortalContainer exists before trying to display it
            if (!jobPortalContainer) { console.error("Job portal container not found!"); return; }

            try {
                const result = await apiRequest('/api/jobs/available');
                if (result.success) {
                    renderJobs(result.jobs);
                } else {
                    showNotification(result.message || 'Failed to load jobs.', 'error');
                }
            } catch (error) {
                showNotification(error.message || 'Failed to load jobs due to network issue.', 'error');
            }
        }

        // --- Initial UI State ---
        // This function runs when the page loads
        function initializeUI() {
            // Ensure loginSignupContainer exists before manipulating its style
            if (loginSignupContainer) {
                loginSignupContainer.style.display = 'block';
            } else {
                console.error("Login/Signup container not found!");
            }
            // Ensure jobPortalContainer exists before manipulating its style
            if (jobPortalContainer) {
                jobPortalContainer.style.display = 'none'; // Hide job portal until login
            } else {
                console.error("Job portal container not found!");
            }
        }
        initializeUI(); // Call on page load
    </script>


</body></html>
```
Okay, I have reviewed the `index (3).html` file you've uploaded.

**I have found the problem!**

The issue is **still the same formatting corruption within the `fetch` API call's URL construction in your `apiRequest` function.** This is the fundamental reason why your frontend is failing and you're getting the "Unexpected token '<'" error.

Look at this section in your `index.html` file (around line 105 in the script block, within the `apiRequest` function):

```html
            const response = await fetch(`<span class="math-inline">\{SERVER\_URL\}</span>{endpoint}`, options);
```

This line is **still corrupted** with `math-inline` and backslashes. This means the browser cannot correctly form the URL for your API requests. It's trying to send the request to a gibberish URL like `"<span%20class="math-inline">\{SERVER\_URL\}</span>/api/signup"` instead of `https://michie-detailing-backend.onrender.com/api/signup`.

**This is the direct cause of your "Unexpected token '<', "<!DOCTYPE "... is not valid JSON" error.**

---

### **The Definitive Fix: Correcting the `fetch` URL in `index.html` (One Last Time)**

We need to fix that one single line in `index.html` to ensure the JavaScript correctly constructs the API call URL.

**Action:** Open your `index.html` file on GitHub for editing.

1.  **Go to your GitHub Repository:**
    * Open your web browser and go to [https://github.com/](https://github.com/) and log in.
    * Navigate to your **frontend repository** (e.g., `your-github-username/michie-detailing-portal-frontend`).
    * Click on **`index.html`**.

2.  **Edit the file:**
    * Click the **pencil icon** to edit the file.

3.  **Find the problematic line:**
    * Scroll down to the `async function apiRequest(endpoint, method = 'GET', data = null)` function (around line 105 in the script block).
    * Locate the line that starts with `const response = await fetch(`.

4.  **Carefully change ONLY that single line to this EXACTLY:**

    **Change this (what you have now):**
    ```html
    const response = await fetch(`<span class="math-inline">\{SERVER\_URL\}</span >\{endpoint}`, options);
    ```
    **TO THIS (the correct version):**
    ```html
    const response = await fetch(`${SERVER_URL}${endpoint}`, options);
    ```
    * **Crucially:**
        * Ensure it starts with a **backtick** `` ` `` (the character typically under the Esc key, not single quotes `'` or double quotes `"`).
        * It should have `${SERVER_URL}` and `${endpoint}` **inside the backticks**, with **no `span`, `math-inline`, or `\` characters** whatsoever.

5.  **Commit the Changes:**
    * Scroll down the page and add a short commit message (e.g., "Final Fix: Corrected API URL construction in fetch").
    * Click the green **"Commit changes"** button.

---

After you commit this change on GitHub, Netlify will automatically detect the change and redeploy your website.

**Once Netlify says "Published"**, **reload your Netlify page** (`https://famous-praline-736e67.netlify.app/`) and then check the Developer Console (F12, "Console" tab) again.

This is the exact, specific syntax error that has been breaking your JavaScript. Fixing this will allow the rest of your script to run, including the buttons, and finally communicate with your Python backe
