from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import uuid
import httpx
import sys
import traceback
import json

app = Flask(__name__)

# --- TEMPORARY: Hardcoded Contractors (for login) ---
CONTRACTORS = {
    "contractor1@example.com": {"password": "password123", "id": "user1"},
    "contractor2@example.com": {"password": "password123", "id": "user2"},
}


# --- Firebase Initialization (TEMPORARILY DISABLED) ---
firebase_admin_initialized = False
db = None

# ... (Firebase initialization block commented out) ...


# --- Pipedrive API Configuration (Direct Calls) ---
PIPEDRIVE_API_TOKEN = os.environ.get('PIPEDRIVE_API_TOKEN')
PIPEDRIVE_COMPANY_DOMAIN = os.environ.get('PIPEDRIVE_COMPANY_DOMAIN')

PIPEDRIVE_BASE_URL = None
if PIPEDRIVE_COMPANY_DOMAIN:
    PIPEDRIVE_BASE_URL = f"https://{PIPEDRIVE_COMPANY_DOMAIN}.pipedrive.com/api/v1"
    print(f"Pipedrive API Base URL: {PIPEDRIVE_BASE_URL}")
else:
    print("WARNING: PIPEDRIVE_COMPANY_DOMAIN environment variable is NOT set. Pipedrive API calls will not work.")

if not PIPEDRIVE_API_TOKEN:
    print("WARNING: PIPEDRIVE_API_TOKEN environment variable is NOT set. Pipedrive API calls will not work.")


# --- CORS Configuration ---
CORS(app, resources={r"/*": {"origins": "https://famous-praline-736e67.netlify.app"}})

# --- Mock Data (for Pipedrive fallback if it fails, OR if you want to remove it later) ---
MOCK_JOBS = [
    {
        "id": "mock-job-1",
        "job_title": "Mock Honda Civic Detail", # Added job_title
        "year": 2020, "make": "Honda", "model": "Civic", "zip_code": "90210",
        "appointment_date": "2025-06-01", "appointment_time": "10:00 AM",
        "estimated_time": "2 hours", # NEW: Estimated time
        "customer_name": "Alice Smith", "customer_phone": "555-123-4567",
        "customer_address": "123 Mock St, Mockville, CA",
        "status": "pending", "accepted_by": None,
    },
    {
        "id": "mock-job-2",
        "job_title": "Mock Tesla Model 3 Clean", # Added job_title
        "year": 2022, "make": "Tesla", "model": "Model 3", "zip_code": "10001",
        "appointment_date": "2025-06-02", "appointment_time": "02:00 PM",
        "estimated_time": "3.5 hours", # NEW: Estimated time
        "customer_name": "Bob Johnson", "customer_phone": "555-987-6543",
        "customer_address": "456 Mock Ave, Mock City, NY",
        "status": "pending", "accepted_by": None,
    },
]

# In-memory token storage (still used for session management)
active_sessions = {} # token: contractor_id (from CONTRACTORS dict)

# --- Helper function for authentication ---
def authenticate_contractor(request):
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return None
    token = auth_header.split(' ')[1]
    return active_sessions.get(token)

# --- Utility function to map Pipedrive deal fields to your job format ---
def map_pipedrive_deal_to_job(deal):
    """
    Maps a Pipedrive deal object to the job format expected by your frontend.
    YOU MUST CUSTOMIZE THIS BASED ON YOUR ACTUAL PIPEDRIVE CUSTOM FIELDS AND WORKFLOW.
    """
    if not deal:
        return None

    job_data = {
        "id": str(deal.get('id')),
        "status": "pending",
        "accepted_by": None,
        "job_title": deal.get('title', "Untitled Job - No Pipedrive Title"),
        "year": "N/A",
        "make": "N/A",
        "model": "N/A",
        "zip_code": "N/A",
        "appointment_date": "N/A",
        "appointment_time": "N/A",
        "estimated_time": "N/A", # NEW: Initialize estimated_time
        "customer_name": "N/A",
        "customer_phone": "N/A",
        "customer_address": "N/A",
    }

    # Map details from the associated Person (if a person is linked to the deal)
    person_data = deal.get('person_id')
    if person_data and isinstance(person_data, dict):
        job_data["customer_name"] = person_data.get('name', "N/A")
        if person_data.get('phone'):
            phone_list = person_data['phone']
            job_data["customer_phone"] = phone_list[0]['value'] if phone_list and isinstance(phone_list, list) and 'value' in phone_list[0] else "N/A"
        job_data["customer_address"] = person_data.get('address', "N/A")

    # --- IMPORTANT: Map your Pipedrive Custom Fields ---
    # To find these keys: Go to Pipedrive -> Company Settings -> Data Fields -> Deals tab.
    # Click on each custom field (e.g., "Vehicle Year", "Vehicle Make") to see its API key (e.g., "f_123abc").
    # REPLACE THE PLACEHOLDERS BELOW WITH YOUR ACTUAL PIPEDRIVE CUSTOM FIELD API KEYS
    # Example: job_data["year"] = deal.get('f_myvehicleyearkey', "N/A")
    job_data["year"] = deal.get('f_YOUR_VEHICLE_YEAR_KEY', "N/A")
    job_data["make"] = deal.get('f_YOUR_VEHICLE_MAKE_KEY', "N/A")
    job_data["model"] = deal.get('f_YOUR_VEHICLE_MODEL_KEY', "N/A")
    job_data["zip_code"] = deal.get('f_YOUR_ZIP_CODE_KEY', "N/A")
    job_data["appointment_date"] = deal.get('f_YOUR_APPOINTMENT_DATE_KEY', "N/A")
    job_data["appointment_time"] = deal.get('f_YOUR_APPOINTMENT_TIME_KEY', "N/A")
    job_data["estimated_time"] = deal.get('f_YOUR_ESTIMATED_TIME_KEY', "N/A") # NEW: Map estimated time custom field
    job_data["customer_address"] = deal.get('f_YOUR_CUSTOMER_ADDRESS_KEY', job_data["customer_address"])

    # --- Status Mapping based on Pipedrive Deal Status or Stage ---
    if deal.get('status') == 'won':
        job_data['status'] = 'accepted'
    elif deal.get('status') == 'lost':
        job_data['status'] = 'declined'
    else:
        job_data['status'] = 'pending'

    return job_data

# --- API Endpoints ---

@app.route('/register', methods=['POST'])
def register():
    return jsonify({"message": "Account creation is temporarily disabled. Please use existing credentials."}), 403


@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

    contractor = CONTRACTORS.get(username)
    if contractor and contractor['password'] == password:
        token = str(uuid.uuid4())
        active_sessions[token] = contractor['id']
        return jsonify({"message": "Login successful", "token": token}), 200
    return jsonify({"message": "Invalid credentials"}), 401


@app.route('/jobs', methods=['GET'])
def get_jobs():
    contractor_id = authenticate_contractor(request)
    if not contractor_id:
        return jsonify({"message": "Unauthorized"}), 401

    if not PIPEDRIVE_BASE_URL or not PIPEDRIVE_API_TOKEN:
        print("Pipedrive API URL or Token not configured. Serving mock data.")
        return jsonify(MOCK_JOBS), 200

    response_jobs = []
    try:
        deals_url = f"{PIPEDRIVE_BASE_URL}/deals"
        params = {'status': 'open', 'api_token': PIPEDRIVE_API_TOKEN}
        
        with httpx.Client(verify=False) as client:
            api_response = client.get(deals_url, params=params)
        
        api_response.raise_for_status()
        
        deals_data = api_response.json()
        
        print(f"DEBUG: Raw Pipedrive deals_response: {json.dumps(deals_data, indent=2)}")
        
        deals = deals_data.get('data')
        print(f"DEBUG: Pipedrive 'data' portion: {json.dumps(deals, indent=2)}")

        if not deals:
            print("No open deals found in Pipedrive or 'data' key missing in response.")
            return jsonify([]), 200

        for deal in deals:
            mapped_job = map_pipedrive_deal_to_job(deal)
            if mapped_job:
                job_to_send = {
                    "id": mapped_job['id'],
                    "job_title": mapped_job['job_title'],
                    "year": mapped_job['year'],
                    "make": mapped_job['make'],
                    "model": mapped_job['model'],
                    "zip_code": mapped_job['zip_code'],
                    "appointment_date": mapped_job['appointment_date'],
                    "appointment_time": mapped_job['appointment_time'],
                    "estimated_time": mapped_job['estimated_time'], # NEW: Include estimated_time
                    "status": mapped_job['status'],
                }
                if mapped_job['status'] == 'accepted':
                    job_to_send["customer_name"] = mapped_job['customer_name']
                    job_to_send["customer_phone"] = mapped_job['customer_phone']
                    job_to_send["customer_address"] = mapped_job['customer_address']
                
                print(f"DEBUG: Job sent to frontend: {json.dumps(job_to_send, indent=2)}") 
                
                response_jobs.append(job_to_send)

    except httpx.RequestError as e:
        print(f"Network or HTTP error fetching deals from Pipedrive (httpx): {e}")
        return jsonify({"message": f"Network error fetching jobs: {e}", "fallback_to_mock": True, "mock_jobs": MOCK_JOBS}), 500
    except ValueError as e:
        print(f"JSON decoding error from Pipedrive response (httpx): {e}. Response text: {api_response.text}")
        return jsonify({"message": f"Data format error from Pipedrive: {e}", "fallback_to_mock": True, "mock_jobs": MOCK_JOBS}), 500
    except Exception as e:
        print(f"Unexpected error fetching deals from Pipedrive: {e}")
        exc_type, exc_value, exc_traceback = sys.exc_info()
        traceback_details = traceback.format_exception(exc_type, exc_value, exc_traceback)
        print("".join(traceback_details))
        return jsonify({"message": f"Error fetching jobs from Pipedrive: {e}", "fallback_to_mock": True, "mock_jobs": MOCK_JOBS}), 500

    return jsonify(response_jobs), 200


@app.route('/jobs/<job_id>/accept', methods=['POST'])
def accept_job(job_id):
    contractor_id = authenticate_contractor(request)
    if not contractor_id:
        return jsonify({"message": "Unauthorized"}), 401

    if not PIPEDRIVE_BASE_URL or not PIPEDRIVE_API_TOKEN:
        return jsonify({"message": "Pipedrive API not configured."}), 500

    try:
        deal_url = f"{PIPEDRIVE_BASE_URL}/deals/{job_id}"
        params = {'api_token': PIPEDRIVE_API_TOKEN}
        
        with httpx.Client(verify=False) as client:
            deal_response = client.get(deal_url, params=params)
        deal_response.raise_for_status()
        current_deal = deal_response.json().get('data')

        if not current_deal:
            return jsonify({"message": "Job (Deal) not found in Pipedrive"}), 404

        if current_deal.get('status') == 'open':
            update_url = f"{PIPEDRIVE_BASE_URL}/deals/{job_id}"
            update_data = {
                'status': 'won',
                # 'stage_id': YOUR_PIPEDRIVE_ACCEPTED_STAGE_ID,
                # 'f_YOUR_CONTRACTOR_ACCEPTED_BY_FIELD_KEY': contractor_id
            }
            update_params = {'api_token': PIPEDRIVE_API_TOKEN}
            
            with httpx.Client(verify=False) as client:
                update_response = client.put(update_url, params=update_params, json=update_data)
            update_response.raise_for_status()

            with httpx.Client(verify=False) as client:
                updated_deal_response = client.get(deal_url, params=params)
            updated_deal_response.raise_for_status()
            updated_deal = updated_deal_response.json().get('data')
            
            if updated_deal:
                job = map_pipedrive_deal_to_job(updated_deal)
                job['status'] = 'accepted'
                job['accepted_by'] = contractor_id
                return jsonify({"message": "Job accepted successfully", "job": job}), 200
            else:
                return jsonify({"message": "Job accepted, but failed to retrieve updated details."}), 200

        elif current_deal.get('status') == 'won':
            return jsonify({"message": "Job already accepted."}), 400
        elif current_deal.get('status') == 'lost':
            return jsonify({"message": "Job has been declined/lost and cannot be accepted."}), 400

    except httpx.RequestError as e:
        print(f"Network or HTTP error accepting job (httpx): {e}")
        return jsonify({"message": f"Network error accepting job: {e}"}), 500
    except ValueError as e:
        print(f"JSON decoding error accepting job (httpx): {e}. Response text: {deal_response.text if 'deal_response' in locals() else 'N/A'}")
        return jsonify({"message": f"Data format error accepting job: {e}"}), 500
    except Exception as e:
        print(f"Unexpected error accepting job: {e}")
        exc_type, exc_value, exc_traceback = sys.exc_info()
        traceback_details = traceback.format_exception(exc_type, exc_value, exc_traceback)
        print("".join(traceback_details))
        return jsonify({"message": f"Error accepting job: {e}"}), 500


@app.route('/jobs/<job_id>/decline', methods=['POST'])
def decline_job(job_id):
    contractor_id = authenticate_contractor(request)
    if not contractor_id:
        return jsonify({"message": "Unauthorized"}), 401

    if not PIPEDRIVE_BASE_URL or not PIPEDRIVE_API_TOKEN:
        return jsonify({"message": "Pipedrive API not configured."}), 500

    try:
        deal_url = f"{PIPEDRIVE_BASE_URL}/deals/{job_id}"
        params = {'api_token': PIPEDRIVE_API_TOKEN}
        
        with httpx.Client(verify=False) as client:
            deal_response = client.get(deal_url, params=params)
        deal_response.raise_for_status()
        current_deal = deal_response.json().get('data')

        if not current_deal:
            return jsonify({"message": "Job (Deal) not found in Pipedrive"}), 404

        if current_deal.get('status') == 'open':
            update_url = f"{PIPEDRIVE_BASE_URL}/deals/{job_id}"
            update_data = {
                'status': 'lost', # Mark as lost
                # 'stage_id': YOUR_PIPEDRIVE_DECLINED_STAGE_ID,
                # 'lost_reason_id': YOUR_LOST_REASON_ID
            }
            update_params = {'api_token': PIPEDRIVE_API_TOKEN}
            
            with httpx.Client(verify=False) as client:
                update_response = client.put(update_url, params=update_params, json=update_data)
            update_response.raise_for_status()

            with httpx.Client(verify=False) as client:
                updated_deal_response = client.get(deal_url, params=params)
            updated_deal_response.raise_for_status()
            updated_deal = updated_deal_response.json().get('data')
            
            if updated_deal:
                job = map_pipedrive_deal_to_job(updated_deal)
                job['status'] = 'declined'
                job['accepted_by'] = contractor_id
                return jsonify({"message": "Job declined successfully", "job": job}), 200
            else:
                return jsonify({"message": "Job declined, but failed to retrieve updated details."}), 200

        elif current_deal.get('status') == 'won':
            return jsonify({"message": "Job already accepted, cannot decline."}), 400
        elif current_deal.get('status') == 'lost':
            return jsonify({"message": "Job already declined."}), 400

    except httpx.RequestError as e:
        print(f"Network or HTTP error declining job (httpx): {e}")
        return jsonify({"message": f"Network error declining job: {e}"}), 500
    except ValueError as e:
        print(f"JSON decoding error declining job (httpx): {e}. Response text: {deal_response.text if 'deal_response' in locals() else 'N/A'}")
        return jsonify({"message": f"Data format error declining job: {e}"}), 500
    except Exception as e:
        print(f"Unexpected error declining job: {e}")
        exc_type, exc_value, exc_traceback = sys.exc_info()
        traceback_details = traceback.format_exception(exc_type, exc_value, exc_traceback)
        print("".join(traceback_details))
        return jsonify({"message": f"Error declining job: {e}"}), 500

@app.route('/')
def home():
    return "Auto Detailing Backend is running!"

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(debug=True, host='0.0.0.0', port=port)
